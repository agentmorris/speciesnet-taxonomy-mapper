<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeciesNet Taxonomy Mapper</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { padding-top: 2rem; }
        .container { max-width: 1400px; }
        textarea, .output-row-input { font-family: monospace; white-space: pre; overflow-x: auto; }
        .output-row { display: flex; gap: 0.5rem; margin-bottom: 2px; }
        .output-row-input { flex-grow: 1; border-color: #ced4da; }
        .output-row-input:read-only { background-color: #e9ecef; }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>SpeciesNet Taxonomy Mapper</h1>
            <div>
                {% if gemini_available %}
                    <span class="badge bg-success">Gemini Online</span>
                {% else %}
                    <span class="badge bg-secondary">Gemini Offline</span>
                {% endif %}
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-12">
                <label for="locationInput" class="form-label">Study Area / Location (Optional)</label>
                <input type="text" class="form-control" id="locationInput" placeholder="e.g. Alberta, Canada or Serengeti National Park">
                <div class="form-text">Providing a location helps resolve ambiguous common names (e.g., "badger").</div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <label for="inputText" class="form-label fw-bold">Input List</label>
                <textarea class="form-control" id="inputText" rows="25" placeholder="deer&#10;bear&#10;odocoileus virginianus&#10;deer,odocoileus virginianus"></textarea>
                <div class="form-text">One entry per line. Supports "Common", "Latin", "Common, Latin".</div>
            </div>
            <div class="col-md-6">
                <label class="form-label fw-bold">Output CSV Preview</label>
                <div id="outputContainer" class="form-control" style="height: auto; min-height: calc(1.5em * 25 + 0.75rem * 2 + 2px); overflow-y: auto;">
                    <div class="text-muted p-2">Results will appear here...</div>
                </div>
            </div>
        </div>
        
        <div class="d-flex gap-2 mt-3">
            <button class="btn btn-primary" id="processBtn">Process Input</button>
            <button class="btn btn-success" id="downloadBtn" disabled>Download CSV</button>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <label for="apiKeyInput" class="form-label">Custom Gemini Key (Optional)</label>
                <input type="password" class="form-control" id="apiKeyInput" placeholder="Enter your own Google Gemini API key...">
                <div class="form-text">If provided, this key will be used instead of the server's default key.</div>
            </div>
        </div>
        
        <div id="statusArea" class="mt-3 d-none">
            <div class="d-flex align-items-center text-primary">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                <span>Processing...</span>
            </div>
        </div>
        
        <div id="errorArea" class="alert alert-danger mt-3 d-none"></div>
    </div>

    <script>
        // DOM Elements
        const processBtn = document.getElementById('processBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const inputText = document.getElementById('inputText');
        const outputContainer = document.getElementById('outputContainer');
        const locationInput = document.getElementById('locationInput');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const statusArea = document.getElementById('statusArea');
        const errorArea = document.getElementById('errorArea');

        // Client-side state to manage rows
        let clientState = {};

        // Main process button handler
        processBtn.addEventListener('click', async () => {
            const originalInputs = inputText.value.split('\n').filter(line => line.trim() !== '');
            if (originalInputs.length === 0) {
                alert("Please enter some text.");
                return;
            }

            let inputsToProcess = [];
            let isFirstRun = Object.keys(clientState).length === 0;

            if (isFirstRun) {
                inputsToProcess = originalInputs;
                 // Initialize state
                originalInputs.forEach((input, index) => {
                    clientState[index] = { original: input, output: '', locked: false };
                });
            } else {
                // Collect unlocked inputs for reprocessing
                originalInputs.forEach((input, index) => {
                    clientState[index].original = input; // Update original text in case it was edited
                    if (!clientState[index].locked) {
                        inputsToProcess.push(input);
                    }
                });
            }
            
            if (inputsToProcess.length === 0) {
                alert("All rows are locked. Unlock some to reprocess.");
                return;
            }

            // UI updates for processing start
            processBtn.disabled = true;
            downloadBtn.disabled = true;
            statusArea.classList.remove('d-none');
            errorArea.classList.add('d-none');
            
            try {
                const formData = new FormData();
                formData.append('input_text', inputsToProcess.join('\n'));
                formData.append('location', locationInput.value);
                formData.append('user_api_key', apiKeyInput.value);

                const response = await fetch('{{ url_for("process") }}', { method: 'POST', body: formData });

                if (!response.ok) throw new Error("Server error: " + response.statusText);

                const csvContent = await response.text();
                const newResults = csvContent.trim().split('\n').slice(1); // Skip header

                // Merge new results with locked rows
                let resultIndex = 0;
                for (let i = 0; i < originalInputs.length; i++) {
                    if (!clientState[i].locked) {
                         if (resultIndex < newResults.length) {
                            clientState[i].output = newResults[resultIndex++];
                         }
                    }
                }
                
                renderOutput();
                downloadBtn.disabled = false;

            } catch (e) {
                errorArea.textContent = e.message;
                errorArea.classList.remove('d-none');
            } finally {
                processBtn.disabled = false;
                statusArea.classList.add('d-none');
            }
        });

        function renderOutput() {
            outputContainer.innerHTML = ''; // Clear previous content
            Object.keys(clientState).forEach(index => {
                const state = clientState[index];
                const rowDiv = document.createElement('div');
                rowDiv.className = 'output-row';

                const inputElem = document.createElement('input');
                inputElem.type = 'text';
                inputElem.className = 'form-control form-control-sm output-row-input';
                inputElem.value = state.output;
                inputElem.readOnly = state.locked;
                inputElem.addEventListener('change', (e) => {
                    // Update state if user manually edits a row
                    state.output = e.target.value;
                });
                
                const lockBtn = document.createElement('button');
                lockBtn.className = `btn btn-sm ${state.locked ? 'btn-primary' : 'btn-outline-secondary'}`;
                lockBtn.innerHTML = `<i class="bi ${state.locked ? 'bi-lock-fill' : 'bi-unlock'}"></i>`;
                lockBtn.title = state.locked ? 'Unlock row' : 'Lock row';
                lockBtn.addEventListener('click', () => toggleLock(index));
                
                rowDiv.appendChild(inputElem);
                rowDiv.appendChild(lockBtn);
                outputContainer.appendChild(rowDiv);
            });
        }
        
        function toggleLock(index) {
            const state = clientState[index];
            state.locked = !state.locked;
            renderOutput(); // Re-render to reflect the change
        }

        downloadBtn.addEventListener('click', () => {
            const header = 'latin,common,original_latin,original_common';
            const rows = Object.values(clientState).map(state => state.output);
            const csvContent = [header, ...rows].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "mapped_taxonomy.csv";
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>
